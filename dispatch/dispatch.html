<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="../images/PULSE OG.png" type="image/png" />
  <title>PULSE ADMIN | Map Dispatch</title>

  <!-- ========== All CSS files linkup ========= -->
  <link rel="stylesheet" href="../admin/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../admin/assets/css/lineicons.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="../admin/assets/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="../admin/assets/css/main.css" />
  <link rel="stylesheet" href="css/accessibility.css" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* ====== Map-Based Dispatch Dashboard ====== */
    :root {
      --dp-bg: #f0f2f5;
      --dp-card: #ffffff;
      --dp-border: #e2e6ea;
      --dp-text: #1e293b;
      --dp-muted: #64748b;
      --dp-red: #ef4444;
      --dp-orange: #f59e0b;
      --dp-green: #22c55e;
      --dp-blue: #3b82f6;
      --dp-purple: #8b5cf6;
      --dp-teal: #14b8a6;
      --dp-radius: 10px;
      --dp-shadow: 0 2px 12px rgba(0,0,0,.08);
    }

    .main-wrapper .section { padding: 0 !important; }
    .main-wrapper .section .container-fluid { padding: 0 !important; max-width: 100% !important; }

    /* ---- Layout Shell ---- */
    .dispatch-shell {
      display: flex;
      height: calc(100vh - 65px);
      overflow: hidden;
      background: var(--dp-bg);
    }

    /* ---- Stats Toolbar ---- */
    .dispatch-toolbar {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 800;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .stat-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--dp-card);
      border-radius: 40px;
      padding: 6px 16px 6px 8px;
      box-shadow: var(--dp-shadow);
      font-size: 13px;
      font-weight: 600;
      color: var(--dp-text);
      border: 1px solid var(--dp-border);
    }

    .stat-chip .chip-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .stat-chip .chip-dot.red   { background: var(--dp-red); }
    .stat-chip .chip-dot.green { background: var(--dp-green); }
    .stat-chip .chip-dot.blue  { background: var(--dp-blue); }
    .stat-chip .chip-dot.orange{ background: var(--dp-orange); }

    /* ---- Map Area ---- */
    .map-area {
      flex: 1;
      position: relative;
      min-width: 0;
    }

    #dispatchMap {
      width: 100%;
      height: 100%;
    }

    /* ---- Map Filter Bar ---- */
    .map-filters {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 800;
      display: flex;
      gap: 6px;
    }

    .map-filter-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--dp-border);
      background: var(--dp-card);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--dp-muted);
      transition: all .2s;
      box-shadow: var(--dp-shadow);
    }

    .map-filter-btn:hover { background: #f8f9fb; }
    .map-filter-btn.active { background: var(--dp-blue); color: #fff; border-color: var(--dp-blue); }

    /* ---- Right Side Panel ---- */
    .side-panel {
      width: 380px;
      background: var(--dp-card);
      border-left: 1px solid var(--dp-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sp-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--dp-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .sp-header h3 {
      font-size: 15px;
      font-weight: 700;
      margin: 0;
      color: var(--dp-text);
    }

    .sp-badge {
      background: var(--dp-red);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 9px;
      border-radius: 20px;
    }

    /* ---- Tabs ---- */
    .sp-tabs {
      display: flex;
      border-bottom: 1px solid var(--dp-border);
      flex-shrink: 0;
    }

    .sp-tab {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--dp-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .sp-tab:hover { color: var(--dp-text); }
    .sp-tab.active { color: var(--dp-blue); border-bottom-color: var(--dp-blue); }

    /* ---- Search ---- */
    .sp-search {
      padding: 10px 18px;
      border-bottom: 1px solid var(--dp-border);
      flex-shrink: 0;
    }

    .sp-search input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--dp-border);
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      background: #f8f9fb;
    }

    .sp-search input:focus { border-color: var(--dp-blue); background: #fff; }

    /* ---- Scrollable List ---- */
    .sp-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
    }

    /* ---- Incident Card ---- */
    .inc-card {
      background: #fff;
      border: 1px solid var(--dp-border);
      border-radius: var(--dp-radius);
      padding: 14px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all .15s;
    }

    .inc-card:hover { border-color: var(--dp-blue); box-shadow: 0 0 0 2px rgba(59,130,246,.12); }
    .inc-card.selected { border-color: var(--dp-blue); background: #f0f6ff; }

    .inc-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .inc-id {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: 700;
      color: var(--dp-text);
    }

    .inc-status {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: .3px;
    }

    .inc-status.new        { background: #fee2e2; color: #dc2626; }
    .inc-status.dispatched { background: #fef3c7; color: #d97706; }
    .inc-status.enroute    { background: #dbeafe; color: #2563eb; }
    .inc-status.resolved   { background: #dcfce7; color: #16a34a; }

    .inc-category {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 600;
      color: var(--dp-text);
      margin-bottom: 4px;
    }

    .cat-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .cat-dot.medical  { background: var(--dp-red); }
    .cat-dot.fire     { background: var(--dp-orange); }
    .cat-dot.crime    { background: var(--dp-purple); }
    .cat-dot.disaster { background: #6366f1; }
    .cat-dot.rescue   { background: var(--dp-teal); }

    .inc-location {
      font-size: 12px;
      color: var(--dp-muted);
      margin-bottom: 6px;
    }

    .inc-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--dp-muted);
    }

    .inc-time { display: flex; align-items: center; gap: 4px; }

    .inc-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .inc-btn {
      flex: 1;
      padding: 7px 0;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
    }

    .inc-btn.dispatch-btn {
      background: var(--dp-blue);
      color: #fff;
    }

    .inc-btn.dispatch-btn:hover { background: #2563eb; }

    .inc-btn.details-btn {
      background: #f1f5f9;
      color: var(--dp-text);
    }

    .inc-btn.details-btn:hover { background: #e2e8f0; }

    /* ---- Responder Card ---- */
    .resp-card {
      background: #fff;
      border: 1px solid var(--dp-border);
      border-radius: var(--dp-radius);
      padding: 14px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all .15s;
    }

    .resp-card:hover { border-color: var(--dp-green); box-shadow: 0 0 0 2px rgba(34,197,94,.12); }

    .resp-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .resp-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--dp-text);
    }

    .resp-status {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 10px;
      border-radius: 20px;
    }

    .resp-status.available  { background: #dcfce7; color: #16a34a; }
    .resp-status.dispatched { background: #fef3c7; color: #d97706; }
    .resp-status.returning  { background: #dbeafe; color: #2563eb; }
    .resp-status.offline    { background: #f1f5f9; color: #94a3b8; }

    .resp-details {
      font-size: 12px;
      color: var(--dp-muted);
      line-height: 1.7;
    }

    .resp-assign-btn {
      width: 100%;
      margin-top: 10px;
      padding: 7px 0;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--dp-green);
      color: #fff;
      transition: all .15s;
    }

    .resp-assign-btn:hover { background: #16a34a; }
    .resp-assign-btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: default; }

    /* ---- Marker Detail Popup ---- */
    .marker-popup {
      min-width: 240px;
    }

    .marker-popup h4 {
      font-size: 14px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }

    .marker-popup .popup-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 3px 0;
      color: #555;
    }

    .marker-popup .popup-row strong {
      color: #1e293b;
    }

    .marker-popup .popup-dispatch-btn {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: var(--dp-blue);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .marker-popup .popup-dispatch-btn:hover { background: #2563eb; }

    /* ---- Assign Modal ---- */
    .assign-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 9000;
      justify-content: center;
      align-items: center;
    }

    .assign-overlay.visible { display: flex; }

    .assign-modal {
      background: var(--dp-card);
      border-radius: 14px;
      width: 440px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
      padding: 24px;
    }

    .assign-modal h3 {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 4px 0;
    }

    .assign-modal .modal-sub {
      font-size: 12px;
      color: var(--dp-muted);
      margin-bottom: 16px;
    }

    .assign-modal .resp-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid var(--dp-border);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all .15s;
    }

    .assign-modal .resp-option:hover { border-color: var(--dp-blue); background: #f0f6ff; }
    .assign-modal .resp-option.selected { border-color: var(--dp-blue); background: #eff6ff; box-shadow: 0 0 0 2px rgba(59,130,246,.2); }

    .resp-option .resp-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #fff;
      flex-shrink: 0;
    }

    .resp-option .resp-icon.ambulance { background: var(--dp-red); }
    .resp-option .resp-icon.fire      { background: var(--dp-orange); }
    .resp-option .resp-icon.police    { background: var(--dp-blue); }
    .resp-option .resp-icon.rescue    { background: var(--dp-teal); }

    .resp-option .resp-opt-info { flex: 1; }
    .resp-option .resp-opt-name { font-size: 13px; font-weight: 600; color: var(--dp-text); }
    .resp-option .resp-opt-meta { font-size: 11px; color: var(--dp-muted); }

    .assign-modal .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .assign-modal .modal-actions .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal-btn.confirm { background: var(--dp-blue); color: #fff; }
    .modal-btn.confirm:hover { background: #2563eb; }
    .modal-btn.confirm:disabled { background: #cbd5e1; cursor: default; }
    .modal-btn.cancel { background: #f1f5f9; color: var(--dp-text); }
    .modal-btn.cancel:hover { background: #e2e8f0; }

    /* ---- Side Panel Toggle (mobile) ---- */
    .sp-toggle-btn {
      display: none;
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 800;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--dp-blue);
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }

    /* ---- Leaflet Popup Override ---- */
    .leaflet-popup-content-wrapper {
      border-radius: 10px !important;
      box-shadow: 0 6px 24px rgba(0,0,0,.15) !important;
    }

    .leaflet-popup-content { margin: 12px 14px !important; }

    /* ---- Responsive ---- */
    @media (max-width: 900px) {
      .side-panel {
        position: fixed;
        right: -400px;
        top: 65px;
        height: calc(100vh - 65px);
        z-index: 1500;
        transition: right .3s ease;
        box-shadow: -4px 0 20px rgba(0,0,0,.15);
      }

      .side-panel.open { right: 0; }

      .sp-toggle-btn { display: flex; align-items: center; justify-content: center; }

      .dispatch-toolbar { top: auto; bottom: 80px; left: 12px; }
    }

    @media (max-width: 500px) {
      .side-panel { width: 100%; right: -100%; }
      .dispatch-toolbar { flex-direction: column; gap: 4px; }
      .map-filters { flex-wrap: wrap; top: 8px; right: 8px; }
    }

    /* ---- Toast Notification ---- */
    .dp-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #1e293b;
      color: #fff;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      z-index: 9999;
      opacity: 0;
      transition: all .35s ease;
      box-shadow: 0 8px 24px rgba(0,0,0,.2);
    }

    .dp-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ---- Pulse animation for active markers ---- */
    @keyframes marker-pulse {
      0%   { box-shadow: 0 0 0 0 rgba(239,68,68,.5); }
      70%  { box-shadow: 0 0 0 14px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }

    .pulse-marker {
      animation: marker-pulse 2s infinite;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- ======== Preloader =========== -->
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  <!-- ======== Preloader =========== -->

  <!-- ======== sidebar-nav start =========== -->
  <aside class="sidebar-nav-wrapper">
    <div class="navbar-logo">
      <a href="index.html" style="display: flex; align-items: center; gap: 10px; text-decoration: none;">
        <img src="../images/PULSE OG.png" alt="logo" style="width: 45px; height: 45px; object-fit: contain;" />
        <span style="font-size: 18px; font-weight: 600; color: #3b5998;">Pulse Dispatch</span>
      </a>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li class="nav-item"><a href="index.html"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 13H10C10.55 13 11 12.55 11 12V4C11 3.45 10.55 3 10 3H4C3.45 3 3 3.45 3 4V12C3 12.55 3.45 13 4 13ZM4 21H10C10.55 21 11 20.55 11 20V16C11 15.45 10.55 15 10 15H4C3.45 15 3 3.45 3 16V20C3 20.55 3.45 21 4 21ZM14 21H20C20.55 21 21 20.55 21 20V12C21 11.45 20.55 11 20 11H14C13.45 11 13 11.45 13 12V20C13 20.55 13.45 21 14 21ZM13 4V8C13 8.55 13.45 9 14 9H20C20.55 9 21 8.55 21 8V4C21 3.45 20.55 3 20 3H14C13.45 3 13 3.45 13 4Z" fill="currentColor"/></svg></span><span class="text">Dashboard</span></a></li>
        <li class="nav-item"><a href="emergencies.html"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" fill="currentColor"/></svg></span><span class="text">Emergencies</span></a></li>
        <li class="nav-item active"><a href="dispatch.html"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm11 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM5 11l1.5-4.5h11L19 11H5z" fill="currentColor"/></svg></span><span class="text">Dispatch</span></a></li>
        <li class="nav-item"><a href="reports.html"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z" fill="currentColor"/></svg></span><span class="text">Reports</span></a></li>
        <li class="nav-item" style="margin-bottom: 15px;"><a href="news-events-view.html"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V5C22 3.9 21.1 3 20 3ZM5 7H10V13H5V7ZM19 17H5V15H19V17ZM19 13H12V11H19V13ZM19 9H12V7H19V9Z" fill="currentColor"/></svg></span><span class="text">News & Events</span></a></li>
      </ul>
    </nav>
  </aside>
  <div class="overlay"></div>
  <!-- ======== sidebar-nav end =========== -->

  <!-- ======== main-wrapper start =========== -->
  <main class="main-wrapper">
    <!-- ========== header start ========== -->
    <header class="header">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-5 col-md-5 col-6">
            <div class="header-left d-flex align-items-center">
              <div class="menu-toggle-btn mr-15">
                <button id="menu-toggle" class="main-btn primary-btn btn-hover">
                  <i class="lni lni-chevron-left me-2"></i> Menu
                </button>
              </div>
              <div class="header-search d-none d-md-flex">
                <form action="#">
                  <input type="text" placeholder="Search..." />
                  <button><i class="lni lni-search-alt"></i></button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-7 col-md-7 col-6">
            <div class="header-right">
              <!-- notification start -->
              <div class="notification-box ml-15 d-none d-md-flex">
                <button class="dropdown-toggle" type="button" id="notification" data-bs-toggle="dropdown" aria-expanded="false">
                  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 20.1667C9.88317 20.1667 8.88718 19.63 8.23901 18.7917H13.761C13.113 19.63 12.1169 20.1667 11 20.1667Z" fill="" />
                    <path d="M10.1157 2.74999C10.1157 2.24374 10.5117 1.83333 11 1.83333C11.4883 1.83333 11.8842 2.24374 11.8842 2.74999V2.82604C14.3932 3.26245 16.3051 5.52474 16.3051 8.24999V14.287C16.3051 14.5301 16.3982 14.7633 16.564 14.9352L18.2029 16.6342C18.4814 16.9229 18.2842 17.4167 17.8903 17.4167H4.10961C3.71574 17.4167 3.5185 16.9229 3.797 16.6342L5.43589 14.9352C5.6017 14.7633 5.69485 14.5301 5.69485 14.287V8.24999C5.69485 5.52474 7.60672 3.26245 10.1157 2.82604V2.74999Z" fill="" />
                  </svg>
                  <span></span>
                </button>
              </div>
              <!-- notification end -->
              <!-- message start -->
              <div class="header-message-box ml-15 d-none d-md-flex">
                <button class="dropdown-toggle" type="button" id="message" data-bs-toggle="dropdown" aria-expanded="false">
                  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.74866 5.97421C7.91444 5.96367 8.08162 5.95833 8.25005 5.95833C12.5532 5.95833 16.0417 9.4468 16.0417 13.75C16.0417 13.9184 16.0364 14.0856 16.0259 14.2514C16.3246 14.138 16.6127 14.003 16.8883 13.8482L19.2306 14.629C19.7858 14.8141 20.3141 14.2858 20.129 13.7306L19.3482 11.3882C19.8694 10.4604 20.1667 9.38996 20.1667 8.25C20.1667 4.70617 17.2939 1.83333 13.75 1.83333C11.0077 1.83333 8.66702 3.55376 7.74866 5.97421Z" fill="" />
                    <path d="M14.6667 13.75C14.6667 17.2938 11.7939 20.1667 8.25004 20.1667C7.11011 20.1667 6.03962 19.8694 5.11182 19.3482L2.76946 20.129C2.21421 20.3141 1.68597 19.7858 1.87105 19.2306L2.65184 16.8882C2.13062 15.9604 1.83338 14.89 1.83338 13.75C1.83338 10.2062 4.70622 7.33333 8.25004 7.33333C11.7939 7.33333 14.6667 10.2062 14.6667 13.75ZM5.95838 13.75C5.95838 13.2437 5.54797 12.8333 5.04171 12.8333C4.53545 12.8333 4.12504 13.2437 4.12504 13.75C4.12504 14.2563 4.53545 14.6667 5.04171 14.6667C5.54797 14.6667 5.95838 14.2563 5.95838 13.75ZM9.16671 13.75C9.16671 13.2437 8.7563 12.8333 8.25004 12.8333C7.74379 12.8333 7.33338 13.2437 7.33338 13.75C7.33338 14.2563 7.74379 14.6667 8.25004 14.6667C8.7563 14.6667 9.16671 14.2563 9.16671 13.75ZM11.4584 14.6667C11.9647 14.6667 12.375 14.2563 12.375 13.75C12.375 13.2437 11.9647 12.8333 11.4584 12.8333C10.9521 12.8333 10.5417 13.2437 10.5417 13.75C10.5417 14.2563 10.9521 14.6667 11.4584 14.6667Z" fill="" />
                  </svg>
                  <span></span>
                </button>
              </div>
              <!-- message end -->
              <!-- profile start -->
              <div class="profile-box ml-15">
                <button class="dropdown-toggle bg-transparent border-0" type="button" id="profile" data-bs-toggle="dropdown" aria-expanded="false">
                  <div class="profile-info">
                    <div class="info">
                      <div class="image">
                        <img src="../admin/assets/images/profile/profile-image.png" alt="" />
                      </div>
                      <div>
                        <h6 class="fw-500">Admin User</h6>
                        <p>Admin</p>
                      </div>
                    </div>
                  </div>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profile">
                  <li><a href="#0"><i class="lni lni-user"></i> View Profile</a></li>
                  <li class="divider"></li>
                  <li><a href="#0" onclick="window.location.href='../index.html'; return false;"><i class="lni lni-exit"></i> Sign Out</a></li>
                </ul>
              </div>
              <!-- profile end -->
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- ========== header end ========== -->

    <!-- ========== Map Dispatch Dashboard ========== -->
    <section class="section">
      <div class="container-fluid">
        <div class="dispatch-shell">
          <!-- ===== Map Area ===== -->
          <div class="map-area">
            <!-- Live Stats Toolbar -->
            <div class="dispatch-toolbar">
              <div class="stat-chip"><span class="chip-dot red"></span><span id="statActive">6</span> Active</div>
              <div class="stat-chip"><span class="chip-dot green"></span><span id="statAvailable">3</span> Available</div>
              <div class="stat-chip"><span class="chip-dot orange"></span><span id="statDispatched">2</span> Dispatched</div>
              <div class="stat-chip"><span class="chip-dot blue"></span><span id="statResolved">1</span> Resolved</div>
            </div>

            <!-- Map Filters -->
            <div class="map-filters">
              <button class="map-filter-btn active" data-filter="all">All</button>
              <button class="map-filter-btn" data-filter="incidents">Incidents</button>
              <button class="map-filter-btn" data-filter="responders">Responders</button>
              <button class="map-filter-btn" data-filter="active-only">Active Only</button>
            </div>

            <!-- Leaflet Map -->
            <div id="dispatchMap"></div>

            <!-- Mobile Side Panel Toggle -->
            <button class="sp-toggle-btn" id="spToggle" title="Incidents Panel">
              <i class="lni lni-list"></i>
            </button>
          </div>

          <!-- ===== Right Side Panel ===== -->
          <div class="side-panel" id="sidePanel">
            <div class="sp-header">
              <h3>Dispatch Console</h3>
              <span class="sp-badge" id="activeCount">6</span>
            </div>

            <!-- Tabs -->
            <div class="sp-tabs">
              <button class="sp-tab active" data-tab="incidents">Incidents</button>
              <button class="sp-tab" data-tab="responders">Responders</button>
            </div>

            <!-- Search -->
            <div class="sp-search">
              <input type="text" id="spSearch" placeholder="Search by ID, location, or category..." />
            </div>

            <!-- Incidents List -->
            <div class="sp-list" id="incidentsList">
              <!-- Populated by JS -->
            </div>

            <!-- Responders List -->
            <div class="sp-list" id="respondersList" style="display:none;">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- ========== Map Dispatch Dashboard End ========== -->
  </main>
  <!-- ======== main-wrapper end =========== -->

  <!-- Assign Responder Modal -->
  <div class="assign-overlay" id="assignOverlay">
    <div class="assign-modal">
      <h3>Assign Responder</h3>
      <p class="modal-sub" id="assignTarget">Select a responder for INC-2026-0147</p>
      <div id="assignOptions">
        <!-- Populated by JS -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="assignCancel">Cancel</button>
        <button class="modal-btn confirm" id="assignConfirm" disabled>Confirm Dispatch</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="dp-toast" id="dpToast"></div>

  <!-- ========== Scripts ========== -->
  <script src="../admin/assets/js/bootstrap.bundle.min.js"></script>
  <script src="../admin/assets/js/main.js"></script>
  <script src="js/mock-data.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  /* ============================================================
     PULSE ‚Äî Map-Based Dispatch Dashboard Engine
     ============================================================ */
  (function () {
    'use strict';

    // ‚îÄ‚îÄ San Juan City center ‚îÄ‚îÄ
    const MAP_CENTER = [14.6019, 121.0355];
    const MAP_ZOOM = 15;

    // ‚îÄ‚îÄ Mock Incident Data ‚îÄ‚îÄ
    const incidents = [
      { id:'INC-2026-0147', category:'Medical',  status:'New',        lat:14.6045, lng:121.0380, location:'Brgy. Greenhills, San Juan City',         reported:'2 mins ago',  priority:'High',   reporter:'Juan Dela Cruz' },
      { id:'INC-2026-0146', category:'Fire',     status:'Dispatched', lat:14.5985, lng:121.0295, location:'Brgy. Addition Hills, San Juan City',     reported:'8 mins ago',  priority:'High',   reporter:'Maria Santos' },
      { id:'INC-2026-0145', category:'Crime',    status:'En Route',   lat:14.6010, lng:121.0340, location:'Brgy. Batis, San Juan City',              reported:'15 mins ago', priority:'Medium', reporter:'Pedro Reyes' },
      { id:'INC-2026-0144', category:'Rescue',   status:'New',        lat:14.5950, lng:121.0370, location:'Brgy. Little Baguio, San Juan City',      reported:'23 mins ago', priority:'High',   reporter:'Ana Garcia' },
      { id:'INC-2026-0143', category:'Medical',  status:'Resolved',   lat:14.6055, lng:121.0320, location:'Brgy. Corazon de Jesus, San Juan City',   reported:'35 mins ago', priority:'Low',    reporter:'Carlos Mendoza' },
      { id:'INC-2026-0142', category:'Disaster', status:'New',        lat:14.5990, lng:121.0410, location:'Brgy. Ermita√±o, San Juan City',           reported:'45 mins ago', priority:'High',   reporter:'Rosa Aquino' },
      { id:'INC-2026-0141', category:'Fire',     status:'Dispatched', lat:14.6030, lng:121.0260, location:'Brgy. Isabelita, San Juan City',          reported:'52 mins ago', priority:'Medium', reporter:'Lito Ferrer' },
      { id:'INC-2026-0140', category:'Crime',    status:'New',        lat:14.6070, lng:121.0350, location:'Brgy. Kabayanan, San Juan City',          reported:'1 hour ago',  priority:'Medium', reporter:'Elena Cruz' }
    ];

    // ‚îÄ‚îÄ Mock Responder Data ‚îÄ‚îÄ
    const responders = [
      { id:'RES-001', name:'Unit A-01 (Ambulance)',  type:'Medical',  typeClass:'ambulance', status:'Available',  lat:14.6020, lng:121.0355, personnel:4, assignedTo:null },
      { id:'RES-002', name:'Unit F-01 (Fire Truck)', type:'Fire',     typeClass:'fire',      status:'Dispatched', lat:14.5988, lng:121.0298, personnel:6, assignedTo:'INC-2026-0146' },
      { id:'RES-003', name:'Unit P-01 (Patrol Car)', type:'Police',   typeClass:'police',    status:'Available',  lat:14.6025, lng:121.0360, personnel:2, assignedTo:null },
      { id:'RES-004', name:'Unit R-01 (Rescue Van)', type:'Rescue',   typeClass:'rescue',    status:'Dispatched', lat:14.5955, lng:121.0372, personnel:5, assignedTo:'INC-2026-0144' },
      { id:'RES-005', name:'Unit A-02 (Ambulance)',  type:'Medical',  typeClass:'ambulance', status:'Available',  lat:14.6040, lng:121.0330, personnel:4, assignedTo:null },
      { id:'RES-006', name:'Unit F-02 (Fire Truck)', type:'Fire',     typeClass:'fire',      status:'Returning', lat:14.6060, lng:121.0310, personnel:6, assignedTo:null },
      { id:'RES-007', name:'Unit P-02 (Patrol Car)', type:'Police',   typeClass:'police',    status:'Available',  lat:14.6005, lng:121.0390, personnel:3, assignedTo:null }
    ];

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let map, incidentMarkers = [], responderMarkers = [];
    let activeFilter = 'all';
    let activeTab = 'incidents';
    let selectedIncidentId = null;
    let selectedResponderId = null;

    // ‚îÄ‚îÄ Category config ‚îÄ‚îÄ
    const catConfig = {
      Medical:  { color: '#ef4444', icon: 'üè•' },
      Fire:    { color: '#f59e0b', icon: 'üî•' },
      Crime:   { color: '#8b5cf6', icon: 'üöî' },
      Disaster:{ color: '#6366f1', icon: 'üåä' },
      Rescue:  { color: '#14b8a6', icon: 'üöÅ' }
    };

    const statusCls = { 'New':'new', 'Dispatched':'dispatched', 'En Route':'enroute', 'Resolved':'resolved' };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  INIT
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', function () {
      initMap();
      renderIncidents();
      renderResponders();
      renderMapMarkers();
      updateStats();
      bindEvents();
      setupMenuToggle();

      // Check for incident parameter from emergencies page
      const params = new URLSearchParams(window.location.search);
      const incidentId = params.get('incident');
      if (incidentId) {
        setTimeout(() => {
          flyToIncident(incidentId);
          highlightIncidentCard(incidentId);
        }, 500);
      }
    });

    function setupMenuToggle() {
      const btn = document.getElementById('menu-toggle');
      const sidebar = document.querySelector('.sidebar-nav-wrapper');
      if (btn) btn.addEventListener('click', () => sidebar.classList.toggle('active'));
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  MAP
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initMap() {
      map = L.map('dispatchMap', {
        center: MAP_CENTER,
        zoom: MAP_ZOOM,
        zoomControl: false
      });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      L.control.zoom({ position: 'bottomleft' }).addTo(map);
    }

    // ‚îÄ‚îÄ Custom Marker Icons ‚îÄ‚îÄ
    function incidentIcon(category, status) {
      const cfg = catConfig[category] || catConfig.Medical;
      const isActive = status !== 'Resolved';
      return L.divIcon({
        className: '',
        html: `<div style="
          width:32px;height:32px;border-radius:50%;
          background:${cfg.color};
          border:3px solid #fff;
          display:flex;align-items:center;justify-content:center;
          font-size:14px;
          box-shadow:0 2px 8px rgba(0,0,0,.3);
          ${isActive ? 'animation:marker-pulse 2s infinite;' : 'opacity:.6;'}
        ">${cfg.icon}</div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -20]
      });
    }

    function responderIcon(typeClass, status) {
      const bg = status === 'Available' ? '#22c55e' : status === 'Returning' ? '#3b82f6' : '#f59e0b';
      const icons = { ambulance:'üöë', fire:'üöí', police:'üöì', rescue:'üöê' };
      return L.divIcon({
        className: '',
        html: `<div style="
          width:30px;height:30px;border-radius:8px;
          background:${bg};
          border:2px solid #fff;
          display:flex;align-items:center;justify-content:center;
          font-size:14px;
          box-shadow:0 2px 8px rgba(0,0,0,.3);
        ">${icons[typeClass] || 'üöó'}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -18]
      });
    }

    function renderMapMarkers() {
      // Clear existing
      incidentMarkers.forEach(m => map.removeLayer(m));
      responderMarkers.forEach(m => map.removeLayer(m));
      incidentMarkers = [];
      responderMarkers = [];

      const showIncidents = activeFilter === 'all' || activeFilter === 'incidents' || activeFilter === 'active-only';
      const showResponders = activeFilter === 'all' || activeFilter === 'responders';

      if (showIncidents) {
        incidents.forEach(inc => {
          if (activeFilter === 'active-only' && inc.status === 'Resolved') return;
          const marker = L.marker([inc.lat, inc.lng], { icon: incidentIcon(inc.category, inc.status) })
            .addTo(map)
            .bindPopup(incidentPopupHTML(inc));
          marker._incId = inc.id;
          marker.on('click', () => {
            selectedIncidentId = inc.id;
            highlightIncidentCard(inc.id);
          });
          incidentMarkers.push(marker);
        });
      }

      if (showResponders) {
        responders.forEach(resp => {
          if (activeFilter === 'active-only' && resp.status === 'Returning') return;
          const marker = L.marker([resp.lat, resp.lng], { icon: responderIcon(resp.typeClass, resp.status) })
            .addTo(map)
            .bindPopup(responderPopupHTML(resp));
          marker._respId = resp.id;
          responderMarkers.push(marker);
        });
      }
    }

    function incidentPopupHTML(inc) {
      const cfg = catConfig[inc.category] || catConfig.Medical;
      return `<div class="marker-popup">
        <h4 style="color:${cfg.color}">${cfg.icon} ${inc.category} Emergency</h4>
        <div class="popup-row"><span>ID</span><strong>${inc.id}</strong></div>
        <div class="popup-row"><span>Status</span><strong>${inc.status}</strong></div>
        <div class="popup-row"><span>Priority</span><strong>${inc.priority}</strong></div>
        <div class="popup-row"><span>Location</span><strong>${inc.location}</strong></div>
        <div class="popup-row"><span>Reported</span><strong>${inc.reported}</strong></div>
        <div class="popup-row"><span>Reporter</span><strong>${inc.reporter}</strong></div>
        ${inc.status !== 'Resolved' ? `<button class="popup-dispatch-btn" onclick="window.dispatchApp.openAssign('${inc.id}')">‚ö° Dispatch Responder</button>` : ''}
      </div>`;
    }

    function responderPopupHTML(resp) {
      const assigned = resp.assignedTo ? `<div class="popup-row"><span>Assigned</span><strong>${resp.assignedTo}</strong></div>` : '';
      return `<div class="marker-popup">
        <h4>${resp.name}</h4>
        <div class="popup-row"><span>Type</span><strong>${resp.type}</strong></div>
        <div class="popup-row"><span>Status</span><strong>${resp.status}</strong></div>
        <div class="popup-row"><span>Personnel</span><strong>${resp.personnel}</strong></div>
        ${assigned}
      </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  SIDE PANEL ‚Äî Incidents
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderIncidents(filter) {
      const list = document.getElementById('incidentsList');
      const q = (filter || '').toLowerCase();
      const filtered = incidents.filter(inc => {
        if (!q) return true;
        return inc.id.toLowerCase().includes(q) || inc.location.toLowerCase().includes(q) || inc.category.toLowerCase().includes(q);
      });

      if (!filtered.length) {
        list.innerHTML = '<div style="text-align:center;padding:40px 20px;color:#94a3b8;font-size:13px;">No incidents match your search.</div>';
        return;
      }

      list.innerHTML = filtered.map(inc => {
        const cat = inc.category.toLowerCase();
        const cls = statusCls[inc.status] || 'new';
        const isSelected = inc.id === selectedIncidentId;
        return `
          <div class="inc-card ${isSelected ? 'selected' : ''}" data-inc-id="${inc.id}">
            <div class="inc-card-top">
              <span class="inc-id">${inc.id}</span>
              <span class="inc-status ${cls}">${inc.status}</span>
            </div>
            <div class="inc-category">
              <span class="cat-dot ${cat}"></span>
              ${inc.category} ‚Äî ${inc.priority} Priority
            </div>
            <div class="inc-location">üìç ${inc.location}</div>
            <div class="inc-meta">
              <span class="inc-time">üïê ${inc.reported}</span>
              <span>üë§ ${inc.reporter}</span>
            </div>
            ${inc.status !== 'Resolved' ? `
            <div class="inc-actions">
              <button class="inc-btn dispatch-btn" onclick="event.stopPropagation(); window.dispatchApp.openAssign('${inc.id}')">‚ö° Dispatch</button>
              <button class="inc-btn details-btn" onclick="event.stopPropagation(); window.dispatchApp.flyToIncident('${inc.id}')">üìç Locate</button>
            </div>` : `
            <div class="inc-actions">
              <button class="inc-btn details-btn" onclick="event.stopPropagation(); window.dispatchApp.flyToIncident('${inc.id}')">üìç Locate</button>
            </div>`}
          </div>`;
      }).join('');

      // Click to select + fly to
      list.querySelectorAll('.inc-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.incId;
          selectedIncidentId = id;
          renderIncidents(document.getElementById('spSearch').value);
          flyToIncident(id);
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  SIDE PANEL ‚Äî Responders
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderResponders(filter) {
      const list = document.getElementById('respondersList');
      const q = (filter || '').toLowerCase();
      const filtered = responders.filter(r => {
        if (!q) return true;
        return r.id.toLowerCase().includes(q) || r.name.toLowerCase().includes(q) || r.type.toLowerCase().includes(q);
      });

      if (!filtered.length) {
        list.innerHTML = '<div style="text-align:center;padding:40px 20px;color:#94a3b8;font-size:13px;">No responders match your search.</div>';
        return;
      }

      list.innerHTML = filtered.map(resp => {
        const sCls = resp.status.toLowerCase().replace(' ', '');
        const assignedLabel = resp.assignedTo ? `Assigned: ${resp.assignedTo}` : 'Standing by';
        return `
          <div class="resp-card" data-resp-id="${resp.id}">
            <div class="resp-card-top">
              <span class="resp-name">${resp.name}</span>
              <span class="resp-status ${sCls}">${resp.status}</span>
            </div>
            <div class="resp-details">
              üë• ${resp.personnel} personnel &nbsp;¬∑&nbsp; ${resp.type}<br/>
              üìã ${assignedLabel}
            </div>
            ${resp.status === 'Available' ?
              `<button class="resp-assign-btn" onclick="event.stopPropagation(); window.dispatchApp.showAssignForResponder('${resp.id}')">Assign to Incident</button>` :
              `<button class="resp-assign-btn" disabled>${resp.status}</button>`
            }
          </div>`;
      }).join('');

      list.querySelectorAll('.resp-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = card.dataset.respId;
          const resp = responders.find(r => r.id === id);
          if (resp) map.flyTo([resp.lat, resp.lng], 17, { duration: 0.8 });
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  FLY TO / HIGHLIGHT
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function flyToIncident(id) {
      const inc = incidents.find(i => i.id === id);
      if (!inc) return;
      map.flyTo([inc.lat, inc.lng], 17, { duration: 0.8 });
      // Open popup
      const marker = incidentMarkers.find(m => m._incId === id);
      if (marker) setTimeout(() => marker.openPopup(), 400);
    }

    function highlightIncidentCard(id) {
      selectedIncidentId = id;
      renderIncidents(document.getElementById('spSearch').value);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  ASSIGN MODAL
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openAssign(incidentId) {
      const inc = incidents.find(i => i.id === incidentId);
      if (!inc) return;

      selectedIncidentId = incidentId;
      selectedResponderId = null;

      document.getElementById('assignTarget').textContent = `Assign a responder to ${inc.id} ‚Äî ${inc.category} at ${inc.location}`;

      const available = responders.filter(r => r.status === 'Available');
      const container = document.getElementById('assignOptions');

      if (!available.length) {
        container.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:20px;">No available responders.</p>';
      } else {
        const icons = { ambulance:'üöë', fire:'üöí', police:'üöì', rescue:'üöê' };
        container.innerHTML = available.map(r => `
          <div class="resp-option" data-resp-id="${r.id}">
            <div class="resp-icon ${r.typeClass}">${icons[r.typeClass] || 'üöó'}</div>
            <div class="resp-opt-info">
              <div class="resp-opt-name">${r.name}</div>
              <div class="resp-opt-meta">${r.type} ¬∑ ${r.personnel} personnel</div>
            </div>
          </div>
        `).join('');

        container.querySelectorAll('.resp-option').forEach(opt => {
          opt.addEventListener('click', () => {
            container.querySelectorAll('.resp-option').forEach(o => o.classList.remove('selected'));
            opt.classList.add('selected');
            selectedResponderId = opt.dataset.respId;
            document.getElementById('assignConfirm').disabled = false;
          });
        });
      }

      document.getElementById('assignConfirm').disabled = true;
      document.getElementById('assignOverlay').classList.add('visible');
    }

    function confirmAssign() {
      if (!selectedIncidentId || !selectedResponderId) return;

      const inc = incidents.find(i => i.id === selectedIncidentId);
      const resp = responders.find(r => r.id === selectedResponderId);
      if (!inc || !resp) return;

      // Update data
      inc.status = 'Dispatched';
      resp.status = 'Dispatched';
      resp.assignedTo = inc.id;
      resp.lat = inc.lat + (Math.random() - 0.5) * 0.001;
      resp.lng = inc.lng + (Math.random() - 0.5) * 0.001;

      // Close modal & refresh
      document.getElementById('assignOverlay').classList.remove('visible');
      renderMapMarkers();
      renderIncidents(document.getElementById('spSearch').value);
      renderResponders(document.getElementById('spSearch').value);
      updateStats();
      showToast(`‚úÖ ${resp.name} dispatched to ${inc.id}`);
    }

    function cancelAssign() {
      document.getElementById('assignOverlay').classList.remove('visible');
      selectedResponderId = null;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  STATS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateStats() {
      const active = incidents.filter(i => i.status !== 'Resolved').length;
      const available = responders.filter(r => r.status === 'Available').length;
      const dispatched = responders.filter(r => r.status === 'Dispatched').length;
      const resolved = incidents.filter(i => i.status === 'Resolved').length;

      document.getElementById('statActive').textContent = active;
      document.getElementById('statAvailable').textContent = available;
      document.getElementById('statDispatched').textContent = dispatched;
      document.getElementById('statResolved').textContent = resolved;
      document.getElementById('activeCount').textContent = active;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  EVENTS
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function bindEvents() {
      // Map filters
      document.querySelectorAll('.map-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.map-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeFilter = btn.dataset.filter;
          renderMapMarkers();
        });
      });

      // Tab switching
      document.querySelectorAll('.sp-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.sp-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          activeTab = tab.dataset.tab;

          document.getElementById('incidentsList').style.display = activeTab === 'incidents' ? '' : 'none';
          document.getElementById('respondersList').style.display = activeTab === 'responders' ? '' : 'none';

          const searchVal = document.getElementById('spSearch').value;
          if (activeTab === 'incidents') renderIncidents(searchVal);
          else renderResponders(searchVal);
        });
      });

      // Search
      document.getElementById('spSearch').addEventListener('input', function () {
        if (activeTab === 'incidents') renderIncidents(this.value);
        else renderResponders(this.value);
      });

      // Assign modal
      document.getElementById('assignConfirm').addEventListener('click', confirmAssign);
      document.getElementById('assignCancel').addEventListener('click', cancelAssign);
      document.getElementById('assignOverlay').addEventListener('click', function (e) {
        if (e.target === this) cancelAssign();
      });

      // Mobile side panel toggle
      document.getElementById('spToggle').addEventListener('click', () => {
        document.getElementById('sidePanel').classList.toggle('open');
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  TOAST
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg) {
      const el = document.getElementById('dpToast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  RESPONDER ‚Üí INCIDENT ASSIGNMENT (from responders tab)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAssignForResponder(respId) {
      // Find unassigned new incidents and let dispatcher pick
      const unhandled = incidents.filter(i => i.status === 'New');
      if (!unhandled.length) {
        showToast('‚ö†Ô∏è No new incidents to assign.');
        return;
      }
      // Open assign for the first new incident (user can pick from popup)
      openAssign(unhandled[0].id);
    }

    // ‚îÄ‚îÄ Public API ‚îÄ‚îÄ
    window.dispatchApp = {
      openAssign,
      flyToIncident,
      showAssignForResponder
    };

  })();
  </script>

  <script src="js/accessibility.js"></script>

  <!-- ========== Accessibility FAB ========== -->
  <button id="a11yFab" class="a11y-fab" title="Accessibility Settings" aria-label="Open Accessibility Settings">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M12 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm9 7h-6l-1.41 7.06L16 22h-2.5l-1.5-5-1.5 5H8l2.41-5.94L9 9H3V7h18v2z"/></svg>
  </button>
  <div id="a11yOverlay" class="a11y-overlay"></div>
  <div id="a11yPanel" class="a11y-panel" role="dialog" aria-label="Accessibility Settings">
    <div class="a11y-panel-header"><h3><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4zm9 7h-6l-1.41 7.06L16 22h-2.5l-1.5-5-1.5 5H8l2.41-5.94L9 9H3V7h18v2z"/></svg> Accessibility Settings</h3><button id="a11yCloseBtn" class="a11y-close-btn" aria-label="Close">&times;</button></div>
    <div class="a11y-panel-body">
      <div class="a11y-section"><h4 class="a11y-section-title"><span class="a11y-icon purple"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5C10.55 5.4 8.45 5 6.5 5 5.33 5 4.11 5.15 3 5.5v14.07c0 .25.25.46.5.37C4.57 19.52 5.53 19.35 6.5 19.35c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5.97 0 1.93.09 2.88.36.23.07.62-.09.62-.36V5z"/></svg></span> Reading Assistance</h4>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Text-to-Speech</strong><small>Click any text to hear it read aloud</small></div><label class="a11y-switch"><input type="checkbox" id="a11yTTS"><span class="a11y-slider"></span></label></div>
        <button id="a11yReadPage" class="a11y-read-page-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg> Read Page Aloud</button>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Dyslexia-Friendly Font</strong><small>Switch to OpenDyslexic typeface</small></div><label class="a11y-switch"><input type="checkbox" id="a11yDyslexia"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Text Size</strong><small>Adjust base text size</small></div><div class="a11y-range-wrap"><input type="range" id="a11yTextSize" class="a11y-range" min="80" max="200" step="10" value="100"><span id="a11yTextSizeVal" class="a11y-range-val">100%</span></div></div>
      </div>
      <div class="a11y-section"><h4 class="a11y-section-title"><span class="a11y-icon blue"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></span> Visual Modes</h4>
        <div class="a11y-option"><div class="a11y-option-info"><strong>High Contrast</strong><small>Dark background with bright text</small></div><label class="a11y-switch"><input type="checkbox" id="a11yContrast"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Large UI Elements</strong><small>Bigger buttons, text, and spacing</small></div><label class="a11y-switch"><input type="checkbox" id="a11yLargeUI"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Simple Mode</strong><small>Hide charts and non-essential details</small></div><label class="a11y-switch"><input type="checkbox" id="a11ySimple"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Colorblind Palette</strong><small>Adjusted colors for color vision deficiency</small></div><label class="a11y-switch"><input type="checkbox" id="a11yColorblind"><span class="a11y-slider"></span></label></div>
      </div>
      <div class="a11y-section"><h4 class="a11y-section-title"><span class="a11y-icon amber"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></span> Navigation & Feedback</h4>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Voice Guidance</strong><small>Announce navigation changes aloud</small></div><label class="a11y-switch"><input type="checkbox" id="a11yVoice"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Icon Labels</strong><small>Show text labels alongside icons</small></div><label class="a11y-switch"><input type="checkbox" id="a11yIconLabels"><span class="a11y-slider"></span></label></div>
        <div class="a11y-option"><div class="a11y-option-info"><strong>Confirmation Prompts</strong><small>Ask before critical actions</small></div><label class="a11y-switch"><input type="checkbox" id="a11yConfirm"><span class="a11y-slider"></span></label></div>
      </div>
      <div class="a11y-section"><h4 class="a11y-section-title"><span class="a11y-icon red"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></span> Emergency</h4>
        <div class="a11y-option"><div class="a11y-option-info"><strong>One-Tap Emergency</strong><small>Show quick emergency shortcut button</small></div><label class="a11y-switch"><input type="checkbox" id="a11yEmergency"><span class="a11y-slider"></span></label></div>
        <button id="a11yEmergencyAction" class="a11y-emergency-btn" style="display:none;"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg> Send Emergency Alert</button>
      </div>
    </div>
    <div class="a11y-panel-footer"><button id="a11yResetBtn" class="a11y-reset-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> Reset All Settings</button></div>
  </div>
</body>
</html>
